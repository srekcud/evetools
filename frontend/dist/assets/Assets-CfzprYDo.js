import{d as le,u as ne,z as $,o as re,i as ie,w as ue,p as i,r as m,h as a,b as s,c as l,n as N,l as P,t as r,e as x,A as de,B as V,C as R,F as y,m as C,D as ce,k as I,s as D}from"./index-BrHa6dug.js";import{u as me}from"./sync-Y-kYcwfb.js";import{u as ve}from"./useEveImages-B3tDia7r.js";import{_ as pe}from"./MainLayout.vue_vue_type_style_index_0_lang-DJ721N8Q.js";const fe={class:"flex items-center justify-between mb-6"},xe=["disabled"],ye={key:0,class:"mb-6"},he={class:"bg-slate-900 rounded-lg p-4 border border-slate-800"},ge={class:"flex items-center justify-between mb-2"},be={class:"text-sm text-slate-300"},we={key:0,class:"text-sm text-cyan-400 font-mono"},ke={class:"h-2 bg-slate-800 rounded-full overflow-hidden"},_e={key:0,class:"mb-6 p-4 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 flex items-center justify-between"},Se={class:"flex flex-col gap-4 mb-6"},Ne={class:"flex flex-col sm:flex-row gap-4"},Ce={class:"flex bg-slate-900 rounded-lg p-1"},Ie=["value"],Me={class:"flex-1 relative"},je={class:"flex flex-col sm:flex-row gap-4"},Ae={class:"relative"},Be={value:""},Le=["value"],Ee={class:"relative"},Te={value:""},$e=["value"],Ve={class:"grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"},ze={class:"bg-slate-900 rounded-lg p-4 border border-slate-800"},qe={class:"text-2xl font-bold text-cyan-400"},Fe={class:"bg-slate-900 rounded-lg p-4 border border-slate-800"},Pe={class:"text-2xl font-bold text-indigo-400"},Re={class:"bg-slate-900 rounded-lg p-4 border border-slate-800"},De={class:"text-2xl font-bold text-amber-400"},He={class:"bg-slate-900 rounded-lg p-4 border border-slate-800"},Qe={class:"text-2xl font-bold text-emerald-400"},Ue={key:1,class:"flex flex-col items-center justify-center py-20"},Oe={key:2,class:"text-center py-20"},We=["disabled"],Je={key:3,class:"space-y-4"},Ge=["onClick"],Ke={class:"flex items-center gap-3"},Xe={class:"w-10 h-10 rounded-lg bg-slate-700/50 flex items-center justify-center"},Ye={class:"font-medium text-slate-200"},Ze={class:"flex items-center gap-2"},et={key:0,class:"text-xs text-cyan-400"},tt={class:"text-xs text-slate-500"},st={class:"text-sm text-cyan-400 font-mono"},ot={key:0,class:"divide-y divide-slate-800"},at=["onClick"],lt={class:"flex items-center gap-3"},nt=["src","alt"],rt={class:"flex items-center gap-2"},it={class:"text-slate-200"},ut={key:0,class:"flex items-center gap-1 text-xs text-amber-400"},dt={key:1,class:"text-xs text-slate-500"},ct={class:"text-slate-400 font-mono text-sm"},mt={key:0,class:"bg-slate-950/50 border-l-2 border-amber-500/30"},vt={class:"flex items-center gap-3"},pt=["src","alt"],ft={class:"text-slate-300 text-sm"},xt={class:"text-slate-500 font-mono text-sm"},yt={key:4,class:"text-center py-12"},St=le({__name:"Assets",setup(ht){const z=ne(),B=me(),{getTypeIconUrl:H,onImageError:L}=ve(),X=i(()=>z.user),M=i(()=>{var t;return((t=X.value)==null?void 0:t.characters)||[]}),v=m(null),u=m([]),j=m(!1),d=m(!1),h=m(""),_=m(""),c=m("character"),p=m(""),g=m(""),b=m(new Set),w=m(new Set),Q=i(()=>{const t=new Set;for(const e of u.value)e.solarSystemName&&t.add(e.solarSystemName);return Array.from(t).sort()}),U=i(()=>{const t=new Map;for(const o of u.value)o.locationName.startsWith("Structure #")||o.locationName.startsWith("Location #")||t.has(o.locationName)||t.set(o.locationName,{solarSystemName:o.solarSystemName});let e=Array.from(t.entries()).map(([o,n])=>({name:o,solarSystemName:n.solarSystemName}));return p.value&&(e=e.filter(o=>o.solarSystemName===p.value)),e.sort((o,n)=>o.name.localeCompare(n.name))}),O=i(()=>new Set(u.value.map(t=>t.itemId))),W=i(()=>{const t=new Map;for(const e of u.value)if(e.locationType==="item"&&O.value.has(e.locationId)){const o=e.locationId;t.has(o)||t.set(o,[]),t.get(o).push(e)}return t});function A(t){return W.value.has(t.itemId)}function q(t){return W.value.get(t.itemId)||[]}function Y(t){b.value.has(t)?b.value.delete(t):b.value.add(t),b.value=new Set(b.value)}function Z(t){w.value.has(t)?w.value.delete(t):w.value.add(t),w.value=new Set(w.value)}const J=i(()=>{let t=u.value;if(p.value&&(t=t.filter(e=>e.solarSystemName===p.value)),g.value&&(t=t.filter(e=>e.locationName===g.value)),_.value.trim()){const e=_.value.toLowerCase();t=t.filter(o=>o.typeName.toLowerCase().includes(e)||o.locationName.toLowerCase().includes(e)||o.solarSystemName&&o.solarSystemName.toLowerCase().includes(e))}return t}),ee=i(()=>{const t={};for(const e of J.value){if(e.locationType==="item"&&O.value.has(e.locationId))continue;const o=e.locationName||`Location ${e.locationId}`;if(t[o]||(t[o]={locationId:e.locationId,locationName:o,solarSystemName:e.solarSystemName,assets:[],totalQuantity:0}),t[o].assets.push(e),t[o].totalQuantity+=e.quantity,A(e))for(const n of q(e))t[o].totalQuantity+=n.quantity}return Object.values(t).sort((e,o)=>e.locationName.localeCompare(o.locationName))});$(p,()=>{g.value=""});const te=i(()=>u.value.reduce((t,e)=>t+e.quantity,0)),se=i(()=>new Set(u.value.map(t=>t.typeId)).size),oe=i(()=>new Set(u.value.map(t=>t.locationId)).size),ae=i(()=>new Set(u.value.filter(t=>t.solarSystemName).map(t=>t.solarSystemName)).size);async function E(){if(!(c.value==="character"&&!v.value)){j.value=!0,h.value="";try{const t=c.value==="character"?`/api/me/characters/${v.value}/assets`:"/api/me/corporation/assets",e=await fetch(t,{headers:{Authorization:`Bearer ${z.token}`}});if(!e.ok)throw new Error("Failed to fetch assets");const o=await D(e);u.value=o.items||[]}catch(t){h.value="Failed to load assets",console.error(t)}finally{j.value=!1}}}const F=i(()=>c.value==="character"?"character-assets":"corporation-assets"),k=i(()=>B.getSyncProgress(F.value));$(()=>k.value,t=>{t&&(t.status==="completed"?(E(),d.value=!1,B.clearSyncStatus(F.value)):t.status==="error"?(h.value=t.message||"Sync failed",d.value=!1,B.clearSyncStatus(F.value)):(t.status==="started"||t.status==="in_progress")&&(d.value=!0))});async function G(){if(!(c.value==="character"&&!v.value)){d.value=!0,h.value="";try{const t=c.value==="character"?`/api/me/characters/${v.value}/assets/refresh`:"/api/me/corporation/assets/refresh",e=await fetch(t,{method:"POST",headers:{Authorization:`Bearer ${z.token}`,"Content-Type":"application/json"},body:JSON.stringify({})});if(!e.ok){const n=await D(e);throw new Error(n.error||"Failed to refresh")}if((await D(e)).status==="pending"){if(!B.isConnected){let n=0;const f=12,T=async()=>{n++,await E(),u.value.length>0||n>=f?d.value=!1:setTimeout(T,5e3)};setTimeout(T,3e3)}}else await E(),d.value=!1}catch(t){h.value=t instanceof Error?t.message:"Failed to refresh assets",d.value=!1}}}re(()=>{if(M.value.length>0){const t=M.value.find(e=>e.isMain);v.value=(t==null?void 0:t.id)||M.value[0].id}}),$(M,t=>{if(t.length>0&&!v.value){const e=t.find(o=>o.isMain);v.value=(e==null?void 0:e.id)||t[0].id}},{immediate:!0}),$([v,c],()=>{p.value="",g.value="",_.value="",b.value=new Set,w.value=new Set,E()},{immediate:!0});function S(t){return t.toLocaleString()}function K(t){return t.itemName?`${t.itemName} (${t.typeName})`:t.typeName}return(t,e)=>(a(),ie(pe,null,{default:ue(()=>[s("div",fe,[e[11]||(e[11]=s("p",{class:"text-slate-400"},"Parcourir vos assets EVE",-1)),s("button",{onClick:G,disabled:d.value||j.value,class:"px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-white text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[(a(),l("svg",{class:N(["w-4 h-4",d.value&&"animate-spin"]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...e[10]||(e[10]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])],2)),P(" "+r(d.value?"Sync...":"Rafraîchir"),1)],8,xe)]),k.value&&(k.value.status==="started"||k.value.status==="in_progress")?(a(),l("div",ye,[s("div",he,[s("div",ge,[s("span",be,r(k.value.message||"Synchronisation..."),1),k.value.progress!==null?(a(),l("span",we,r(k.value.progress)+"%",1)):x("",!0)]),s("div",ke,[s("div",{class:"h-full bg-gradient-to-r from-cyan-500 to-cyan-400 transition-all duration-300",style:de({width:(k.value.progress??0)+"%"})},null,4)])])])):x("",!0),s("div",null,[h.value?(a(),l("div",_e,[s("span",null,r(h.value),1),s("button",{onClick:e[0]||(e[0]=o=>h.value=""),class:"text-red-400 hover:text-red-300"},[...e[12]||(e[12]=[s("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])):x("",!0),s("div",Se,[s("div",Ne,[s("div",Ce,[s("button",{onClick:e[1]||(e[1]=o=>c.value="character"),class:N(["px-4 py-2 rounded-md text-sm font-medium transition-colors",c.value==="character"?"bg-cyan-600 text-white":"text-slate-400 hover:text-slate-200"])}," Personnage ",2),s("button",{onClick:e[2]||(e[2]=o=>c.value="corporation"),class:N(["px-4 py-2 rounded-md text-sm font-medium transition-colors",c.value==="corporation"?"bg-cyan-600 text-white":"text-slate-400 hover:text-slate-200"])}," Corporation ",2)]),c.value==="character"?V((a(),l("select",{key:0,"onUpdate:modelValue":e[3]||(e[3]=o=>v.value=o),class:"bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-cyan-500"},[(a(!0),l(y,null,C(M.value,o=>(a(),l("option",{key:o.id,value:o.id},r(o.name)+" "+r(o.isMain?"(Main)":""),9,Ie))),128))],512)),[[R,v.value]]):x("",!0),s("div",Me,[e[13]||(e[13]=s("svg",{class:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)),V(s("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>_.value=o),type:"text",placeholder:"Rechercher items, emplacements ou systèmes...",class:"w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-cyan-500"},null,512),[[ce,_.value]])])]),s("div",je,[s("div",Ae,[V(s("select",{"onUpdate:modelValue":e[5]||(e[5]=o=>p.value=o),class:"bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 pr-8 text-sm focus:outline-none focus:border-cyan-500 min-w-[200px]"},[s("option",Be,"Tous les systèmes ("+r(Q.value.length)+")",1),(a(!0),l(y,null,C(Q.value,o=>(a(),l("option",{key:o,value:o},r(o),9,Le))),128))],512),[[R,p.value]])]),s("div",Ee,[V(s("select",{"onUpdate:modelValue":e[6]||(e[6]=o=>g.value=o),class:"bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 pr-8 text-sm focus:outline-none focus:border-cyan-500 min-w-[250px]"},[s("option",Te,"Tous les emplacements ("+r(U.value.length)+")",1),(a(!0),l(y,null,C(U.value,o=>(a(),l("option",{key:o.name,value:o.name},r(o.name),9,$e))),128))],512),[[R,g.value]])]),p.value||g.value||_.value?(a(),l("button",{key:0,onClick:e[7]||(e[7]=o=>{p.value="",g.value="",_.value=""}),class:"px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-slate-200 text-sm flex items-center gap-2"},[...e[14]||(e[14]=[s("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1),P(" Effacer filtres ",-1)])])):x("",!0)])]),s("div",Ve,[s("div",ze,[s("p",qe,r(S(te.value)),1),e[15]||(e[15]=s("p",{class:"text-sm text-slate-500"},"Items total",-1))]),s("div",Fe,[s("p",Pe,r(S(se.value)),1),e[16]||(e[16]=s("p",{class:"text-sm text-slate-500"},"Types d'items",-1))]),s("div",Re,[s("p",De,r(S(ae.value)),1),e[17]||(e[17]=s("p",{class:"text-sm text-slate-500"},"Systèmes",-1))]),s("div",He,[s("p",Qe,r(S(oe.value)),1),e[18]||(e[18]=s("p",{class:"text-sm text-slate-500"},"Emplacements",-1))])]),j.value?(a(),l("div",Ue,[...e[19]||(e[19]=[s("svg",{class:"w-10 h-10 animate-spin text-cyan-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),s("p",{class:"text-slate-400"},"Chargement des assets...",-1)])])):u.value.length===0?(a(),l("div",Oe,[d.value?(a(),l(y,{key:0},[e[20]||(e[20]=s("svg",{class:"w-16 h-16 mx-auto text-cyan-500 mb-4 animate-spin",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1.5",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)),e[21]||(e[21]=s("p",{class:"text-slate-300 font-medium mb-2"},"Synchronisation en cours...",-1)),e[22]||(e[22]=s("p",{class:"text-slate-500 text-sm max-w-md mx-auto"}," Récupération de vos assets depuis l'API EVE Online. Cette opération peut prendre quelques minutes lors de la première synchronisation. ",-1))],64)):(a(),l(y,{key:1},[e[23]||(e[23]=s("svg",{class:"w-16 h-16 mx-auto text-slate-700 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1.5",d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"})],-1)),e[24]||(e[24]=s("p",{class:"text-slate-500 mb-4"},"Aucun asset trouvé",-1)),s("button",{onClick:G,disabled:d.value,class:"text-cyan-400 hover:underline text-sm"}," Rafraîchir depuis l'API EVE ",8,We)],64))])):(a(),l("div",Je,[(a(!0),l(y,null,C(ee.value,o=>(a(),l("div",{key:o.locationName,class:"bg-slate-900 rounded-lg border border-slate-800 overflow-hidden"},[s("div",{class:"px-5 py-4 bg-slate-800/50 border-b border-slate-800 flex items-center justify-between cursor-pointer hover:bg-slate-800/70 transition-colors",onClick:n=>Z(o.locationName)},[s("div",Ke,[s("div",Xe,[(a(),l("svg",{class:N(["w-5 h-5 text-slate-400 transition-transform",w.value.has(o.locationName)&&"-rotate-90"]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...e[25]||(e[25]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))]),s("div",null,[s("h3",Ye,r(o.locationName),1),s("div",Ze,[o.solarSystemName&&!o.locationName.startsWith(o.solarSystemName)?(a(),l("span",et,r(o.solarSystemName),1)):x("",!0),s("span",tt,r(o.assets.length)+" types d'items",1)])])]),s("span",st,r(S(o.totalQuantity))+" items",1)],8,Ge),w.value.has(o.locationName)?x("",!0):(a(),l("div",ot,[(a(!0),l(y,null,C(o.assets,n=>(a(),l(y,{key:n.id},[s("div",{class:N(["px-5 py-3 flex items-center justify-between transition-colors",A(n)?"hover:bg-slate-800/50 cursor-pointer":"hover:bg-slate-800/30"]),onClick:f=>A(n)&&Y(n.itemId)},[s("div",lt,[s("img",{src:I(H)(n.typeId,32),alt:n.typeName,class:"w-8 h-8 rounded",onError:e[8]||(e[8]=(...f)=>I(L)&&I(L)(...f))},null,40,nt),s("div",rt,[s("span",it,r(K(n)),1),A(n)?(a(),l("span",ut,[e[27]||(e[27]=s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"})],-1)),P(" "+r(q(n).length)+" items ",1),(a(),l("svg",{class:N(["w-3 h-3 transition-transform",b.value.has(n.itemId)&&"rotate-180"]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...e[26]||(e[26]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))])):n.locationFlag?(a(),l("span",dt,"("+r(n.locationFlag)+")",1)):x("",!0)])]),s("span",ct,"x"+r(S(n.quantity)),1)],10,at),A(n)&&b.value.has(n.itemId)?(a(),l("div",mt,[(a(!0),l(y,null,C(q(n),f=>(a(),l("div",{key:f.id,class:"px-5 py-2 pl-12 flex items-center justify-between hover:bg-slate-800/20 transition-colors"},[s("div",vt,[s("img",{src:I(H)(f.typeId,32),alt:f.typeName,class:"w-6 h-6 rounded",onError:e[9]||(e[9]=(...T)=>I(L)&&I(L)(...T))},null,40,pt),s("span",ft,r(K(f)),1)]),s("span",xt,"x"+r(S(f.quantity)),1)]))),128))])):x("",!0)],64))),128))]))]))),128))])),!j.value&&u.value.length>0&&J.value.length===0?(a(),l("div",yt,[...e[28]||(e[28]=[s("p",{class:"text-slate-500"},"Aucun item correspondant à vos filtres",-1)])])):x("",!0)])]),_:1}))}});export{St as default};
