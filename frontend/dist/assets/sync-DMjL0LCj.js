import{E as T,u as J,z as L,r as l,p as o,s as $}from"./index-DyXu58aN.js";const D=T("sync",()=>{const d=J(),n=l(null),c=l(!1),u=l(null),t=l({}),a=l(0),h=5,g=3e3;let i=null;const y=o(()=>Object.values(t.value).some(e=>e.status==="started"||e.status==="in_progress")),S=o(()=>t.value["character-assets"]??null),b=o(()=>t.value["corporation-assets"]??null),P=o(()=>t.value.ansiblex??null),w=o(()=>t.value["industry-jobs"]??null),k=o(()=>t.value.pve??null),A=o(()=>t.value["market-structure"]??null),M=o(()=>t.value["industry-project"]??null),E=o(()=>t.value["industry-job-completed"]??null);async function F(){try{const e=await fetch("/api/mercure/token",{headers:{Authorization:`Bearer ${d.token}`}});if(!e.ok)throw new Error("Failed to fetch Mercure token");return await $(e)}catch(e){return console.error("Failed to fetch Mercure token:",e),u.value="Failed to get subscription token",null}}async function f(){if(n.value&&c.value)return!0;if(!d.isAuthenticated)return!1;p();const e=await F();if(!e)return!1;try{const r=new URL(e.hubUrl,window.location.origin);return e.topics.forEach(v=>{r.searchParams.append("topic",v)}),r.searchParams.set("authorization",e.token),n.value=new EventSource(r.toString()),n.value.onopen=()=>{c.value=!0,u.value=null,a.value=0,console.debug("Mercure: Connected")},n.value.onmessage=v=>{try{const s=JSON.parse(v.data);t.value={...t.value,[s.syncType]:s},console.debug("Mercure: Received update",s)}catch(s){console.error("Mercure: Failed to parse message",s)}},n.value.onerror=v=>{var s;console.error("Mercure: Connection error"),c.value=!1,((s=n.value)==null?void 0:s.readyState)===EventSource.CLOSED&&R()},!0}catch(r){return console.error("Mercure: Failed to connect",r),u.value="Failed to establish real-time connection",!1}}function p(){i&&(clearTimeout(i),i=null),n.value&&(n.value.close(),n.value=null),c.value=!1}function R(){if(a.value>=h){u.value="Real-time connection lost. Refresh the page to reconnect.",console.error("Mercure: Max reconnect attempts reached");return}a.value++;const e=g*Math.pow(2,a.value-1);console.debug(`Mercure: Attempting reconnect ${a.value}/${h} in ${e}ms`),i=setTimeout(()=>{f()},e)}function j(e){return t.value[e]??null}function x(e){const r=t.value[e];return(r==null?void 0:r.status)==="started"||(r==null?void 0:r.status)==="in_progress"}function C(e){const r={...t.value};delete r[e],t.value=r}function m(){t.value={}}return L(()=>d.isAuthenticated,e=>{e?f():(p(),m())},{immediate:!0}),{isConnected:c,connectionError:u,syncStatus:t,reconnectAttempts:a,isAnyLoading:y,characterAssetsProgress:S,corporationAssetsProgress:b,ansiblexProgress:P,industryJobsProgress:w,pveProgress:k,marketStructureProgress:A,industryProjectProgress:M,industryJobCompletedProgress:E,connect:f,disconnect:p,getSyncProgress:j,isLoading:x,clearSyncStatus:C,clearAllSyncStatus:m}});export{D as u};
